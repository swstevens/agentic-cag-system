---
title: MTG Deck Builder Frontend - FSM Architecture
---

stateDiagram-v2
    [*] --> MainBuilder: Initial Load

    state MainBuilder {
        [*] --> EmptyDeck
        EmptyDeck --> DeckLoaded: Chat Message → Backend API
        DeckLoaded --> DeckLoaded: Chat Message → Backend API
        DeckLoaded --> DeckSaved: Save Deck → Supabase
        DeckSaved --> DeckLoaded: Continue Building
    }

    note right of EmptyDeck
        No deck in session
        Chat input active
        Empty deck list panel
    end note

    note right of DeckLoaded
        Current deck in session
        Cards displayed by type
        Save form visible
        Session auto-updates
    end note

    note right of DeckSaved
        Deck persisted to Supabase
        Saved count updated
        Current deck remains loaded
    end note

    MainBuilder --> SavedDecksPage: Click "View Saved"
    SavedDecksPage --> MainBuilder: Click "Back to Builder"
    SavedDecksPage --> MainBuilder: Load Deck → Supabase Read

    state SavedDecksPage {
        [*] --> ViewingDecks
        ViewingDecks --> EditingDeck: Click "Edit Name"
        EditingDeck --> ViewingDecks: Save/Cancel
        ViewingDecks --> UpdatingCategory: Select Category
        UpdatingCategory --> ViewingDecks: Update → Supabase
        ViewingDecks --> DeletingDeck: Click "Delete"
        DeletingDeck --> ViewingDecks: Confirm → Supabase
    }

    note right of ViewingDecks
        List all saved decks
        Load from Supabase
        Display by category
    end note

    note right of EditingDeck
        Inline edit form
        HTMX partial update
    end note

    state "Backend Services" as Backend {
        state "FastAPI Backend" as API {
            [*] --> ChatEndpoint
            ChatEndpoint --> DeckBuilderService: /api/chat
            DeckBuilderService --> MultiAgentOrchestrator
            MultiAgentOrchestrator --> VectorStore: Synergy Lookup
            MultiAgentOrchestrator --> CardDatabase: Card Search
        }

        state "Supabase Services" as Supabase {
            SavedDecksTable
            UserSessionsTable
        }
    }

    note right of SavedDecksTable
        Table: saved_decks
        id, user_id, name
        deck_data (jsonb)
        category, timestamps
    end note

    note right of UserSessionsTable
        Table: user_sessions
        session_id, user_id
        current_deck (jsonb)
        context, messages
    end note

    state "HTMX Interactions" as HTMX

    note right of HTMX
        Partial Updates:
        POST /chat → main-content
        POST /save_deck → deck-list
        POST /load_deck/id → body
        GET /edit_deck/id → saved-deck
        DELETE /delete_deck/id → saved-deck
        POST /update_category/id → saved-deck
    end note

    note left of Backend
        Service Layer:
        - FastAPI (localhost:8000)
        - Multi-Agent Orchestrator
        - Vector Store (ChromaDB)
        - Card Database (SQLite)
    end note

    note right of Supabase
        Future Implementation:
        - Replace session storage
        - User authentication
        - Real-time deck sync
        - Collaborative features
    end note

classDef currentImpl fill:#10b981,stroke:#059669,color:#fff
classDef futureImpl fill:#f59e0b,stroke:#d97706,color:#fff
classDef apiService fill:#2563eb,stroke:#1d4ed8,color:#fff

class MainBuilder,SavedDecksPage,HTMX currentImpl
class Supabase,UserSessionsTable,SavedDecksTable futureImpl
class API,Backend apiService
