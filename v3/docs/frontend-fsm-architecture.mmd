---
title: MTG Deck Builder Frontend - FSM Architecture
---

stateDiagram-v2
    [*] --> MainBuilder: Initial Load

    state MainBuilder {
        [*] --> EmptyDeck
        EmptyDeck --> DeckLoaded: Chat Message → Backend API
        DeckLoaded --> DeckLoaded: Chat Message → Backend API + Current Deck
        DeckLoaded --> DeckSaved: Save Deck → SQLite (POST /api/decks)
        DeckSaved --> DeckLoaded: Continue Building
    }

    note right of EmptyDeck
        No deck in session
        Chat input active
        Empty deck list panel
    end note

    note right of DeckLoaded
        Current deck in session
        Cards displayed by type
        Save form visible
        Session auto-updates
    end note

    note right of DeckSaved
        Deck persisted to SQLite
        Saved count updated
        Current deck remains loaded
    end note

    MainBuilder --> SavedDecksPage: Click "View Saved"
    SavedDecksPage --> MainBuilder: Click "Back to Builder"
    SavedDecksPage --> MainBuilder: Load Deck → SQLite Read (GET /api/decks/id)

    state SavedDecksPage {
        [*] --> ViewingDecks
        ViewingDecks --> EditingDeck: Click "Edit Name"
        EditingDeck --> ViewingDecks: Save/Cancel (PUT /api/decks/id)
        ViewingDecks --> UpdatingCategory: Select Category
        UpdatingCategory --> ViewingDecks: Update → SQLite (PUT /api/decks/id)
        ViewingDecks --> DeletingDeck: Click "Delete"
        DeletingDeck --> ViewingDecks: Confirm → SQLite (DELETE /api/decks/id)
    }

    note right of ViewingDecks
        List all saved decks
        Load from SQLite (GET /api/decks)
        Display by category
    end note

    note right of EditingDeck
        Inline edit form
        HTMX partial update
    end note

    state "Backend Services" as Backend {
        state "FastAPI Backend" as API {
            [*] --> ChatEndpoint
            ChatEndpoint --> DeckBuilderService: /api/chat
            DeckBuilderService --> MultiAgentOrchestrator
            MultiAgentOrchestrator --> VectorStore: Synergy Lookup
            MultiAgentOrchestrator --> CardDatabase: Card Search
        }

        state "SQLite Database" as SQLiteDB {
            CardsTable
            SavedDecksTable
        }
    }

    note right of SavedDecksTable
        Table: saved_decks
        id (auto), name, deck_data (JSON)
        category, created_at, updated_at
        Indexes: name, category
    end note

    note right of CardsTable
        Table: cards
        Card database with full MTG data
        Used by deck building FSM
    end note

    state "HTMX Interactions" as HTMX

    note right of HTMX
        Partial Updates:
        POST /chat → main-content
        POST /save_deck → deck-list
        POST /load_deck/id → body
        GET /edit_deck/id → saved-deck
        DELETE /delete_deck/id → saved-deck
        POST /update_category/id → saved-deck
    end note

    note left of Backend
        Service Layer:
        - FastAPI (localhost:8000)
        - Multi-Agent Orchestrator
        - Vector Store (ChromaDB)
        - SQLite Database (cards + saved_decks)
    end note

    note right of SQLiteDB
        Persistent Storage:
        - All decks saved to database
        - CRUD via REST API
        - No session dependency
        - Ready for user auth
    end note

classDef currentImpl fill:#10b981,stroke:#059669,color:#fff
classDef database fill:#8b5cf6,stroke:#7c3aed,color:#fff
classDef apiService fill:#2563eb,stroke:#1d4ed8,color:#fff

class MainBuilder,SavedDecksPage,HTMX currentImpl
class SQLiteDB,CardsTable,SavedDecksTable database
class API,Backend apiService
