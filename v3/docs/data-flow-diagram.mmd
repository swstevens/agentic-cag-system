---
title: MTG Deck Builder - Data Flow Architecture
---

flowchart TB
    User([User Browser])

    subgraph Frontend["FastHTML Frontend (Port 5000)"]
        direction TB
        MainPage[Main Builder Page<br/>Two-Column Layout]
        SavedPage[Saved Decks Page]

        subgraph Components["FastHTML Components"]
            ChatComp[Chat Component<br/>chat.py]
            DeckListComp[Deck List Component<br/>deck_list.py]
            CardComp[Card Component<br/>card.py]
            SavedComp[Saved Decks Component<br/>saved_decks.py]
        end

        subgraph Routes["Route Handlers"]
            RootRoute[GET / - Main Page]
            ChatRoute[POST /chat - Send Message]
            SaveRoute[POST /save_deck - Save Deck]
            DecksRoute[GET /decks - View Saved]
            LoadRoute[POST /load_deck/id]
            EditRoute[GET/POST /edit_deck/id]
            DeleteRoute[DELETE /delete_deck/id]
            CategoryRoute[POST /update_category/id]
        end
    end

    subgraph SessionStore["Session Storage (Frontend Only)"]
        direction LR
        SessionDeck[Current Deck<br/>session.deck]
        SessionMsgs[Chat Messages<br/>session.messages]
        SessionCtx[Context<br/>session.context]
    end

    subgraph Backend["FastAPI Backend (Port 8000)"]
        direction TB
        APIRouter[API Router<br/>/api/v1/*]

        subgraph Endpoints["API Endpoints"]
            ChatEndpoint[POST /api/chat]
            DecksEndpoint[GET/POST /api/decks]
            DeckEndpoint[GET/PUT/DELETE /api/decks/id]
            CardsEndpoint[GET /api/v1/cards]
            SynergyEndpoint[GET /api/v1/synergy/card]
        end

        subgraph Services["Backend Services"]
            Orchestrator[Multi-Agent Orchestrator]
            DeckBuilder[Deck Builder Service]
            VectorSvc[Vector Store Service<br/>ChromaDB]
            CardLookup[Card Lookup Service]
            SynergyLookup[Synergy Lookup Service]
        end
    end

    subgraph SQLiteDB["SQLite Database"]
        direction TB

        subgraph Tables["Database Tables"]
            CardsDBTable[(cards<br/>- MTG card data<br/>- 20000+ cards)]
            SavedDecksTable[(saved_decks<br/>- id (autoincrement)<br/>- name<br/>- deck_data (JSON)<br/>- category<br/>- timestamps)]
        end

        DatabaseSvc[Database Service<br/>CRUD Operations]
    end

    subgraph Data["Data Stores"]
        CardDB[(Card Database<br/>SQLite)]
        VectorDB[(Vector Store<br/>ChromaDB)]
        CacheL1[L1 Cache<br/>200 items]
        CacheL2[L2 Cache<br/>1000 items]
    end

    %% User Interactions
    User -->|1. Navigate| MainPage
    User -->|2. Send Message| ChatRoute
    User -->|3. Save Deck| SaveRoute
    User -->|4. View Saved| DecksRoute
    User -->|5. Load Deck| LoadRoute

    %% Frontend Component Flow
    MainPage --> DeckListComp
    MainPage --> ChatComp
    DeckListComp --> CardComp
    SavedPage --> SavedComp

    %% Route to Component
    RootRoute --> MainPage
    ChatRoute --> ChatComp
    DecksRoute --> SavedPage

    %% Session Interaction (Frontend State Only)
    ChatRoute <--> SessionDeck
    ChatRoute <--> SessionMsgs
    ChatRoute <--> SessionCtx

    %% Frontend to Backend API Calls
    ChatRoute -->|POST + current_deck| ChatEndpoint
    SaveRoute -->|POST| DecksEndpoint
    DecksRoute -->|GET| DecksEndpoint
    LoadRoute -->|GET| DeckEndpoint
    EditRoute -->|GET/PUT| DeckEndpoint
    DeleteRoute -->|DELETE| DeckEndpoint
    CategoryRoute -->|PUT| DeckEndpoint

    %% Backend Deck Endpoints to Database
    DecksEndpoint --> DatabaseSvc
    DeckEndpoint --> DatabaseSvc
    DatabaseSvc --> SavedDecksTable

    %% Backend Chat Flow
    ChatEndpoint --> Orchestrator

    %% Backend Service Flow
    Orchestrator --> DeckBuilder
    DeckBuilder --> VectorSvc
    DeckBuilder --> CardLookup
    DeckBuilder --> SynergyLookup

    %% Backend Data Access
    CardLookup --> CardDB
    VectorSvc --> VectorDB
    CardLookup --> CacheL1
    CardLookup --> CacheL2

    %% Response Flow
    Orchestrator -->|Deck Data| ChatEndpoint
    ChatEndpoint -->|JSON Response| ChatRoute
    ChatRoute -->|Update Session| SessionDeck
    ChatRoute -->|HTMX Swap| MainPage

    %% Saved Deck Responses
    DecksEndpoint -->|JSON| SaveRoute
    DecksEndpoint -->|JSON List| DecksRoute
    DeckEndpoint -->|JSON| LoadRoute
    DeckEndpoint -->|JSON| EditRoute
    LoadRoute -->|Update Session| SessionDeck

    %% Styling
    classDef current fill:#10b981,stroke:#059669,color:#fff
    classDef backend fill:#2563eb,stroke:#1d4ed8,color:#fff
    classDef database fill:#8b5cf6,stroke:#7c3aed,color:#fff
    classDef data fill:#64748b,stroke:#475569,color:#fff

    class Frontend,Components,Routes,SessionStore current
    class Backend,Endpoints,Services,Orchestrator backend
    class SQLiteDB,Tables,DatabaseSvc,CardsDBTable,SavedDecksTable database
    class Data,CardDB,VectorDB,CacheL1,CacheL2 data
